"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// TODO: fix typings.
// tslint:disable-next-line:no-global-tslint-disable
// tslint:disable:no-any
const fs = require("fs");
const path = require("path");
const ts = require("typescript");
const ngtools_api_1 = require("./ngtools_api");
const resource_loader_1 = require("./resource_loader");
class ExtractI18nPlugin {
    constructor(options) {
        this._compilerOptions = null;
        this._angularCompilerOptions = null;
        this._setupOptions(options);
    }
    _setupOptions(options) {
        if (!options.hasOwnProperty('tsConfigPath')) {
            throw new Error('Must specify "tsConfigPath" in the configuration of @ngtools/webpack.');
        }
        // TS represents paths internally with '/' and expects the tsconfig path to be in this format
        this._tsConfigPath = options.tsConfigPath.replace(/\\/g, '/');
        // Check the base path.
        const maybeBasePath = path.resolve(process.cwd(), this._tsConfigPath);
        let basePath = maybeBasePath;
        if (fs.statSync(maybeBasePath).isFile()) {
            basePath = path.dirname(basePath);
        }
        if (options.hasOwnProperty('basePath')) {
            basePath = path.resolve(process.cwd(), options.basePath || '');
        }
        let tsConfigJson = null;
        try {
            tsConfigJson = JSON.parse(fs.readFileSync(this._tsConfigPath, 'utf8'));
        }
        catch (err) {
            throw new Error(`An error happened while parsing ${this._tsConfigPath} JSON: ${err}.`);
        }
        const tsConfig = ts.parseJsonConfigFileContent(tsConfigJson, ts.sys, basePath, undefined, this._tsConfigPath);
        let fileNames = tsConfig.fileNames;
        if (options.hasOwnProperty('exclude')) {
            const exclude = typeof options.exclude == 'string'
                ? [options.exclude] : options.exclude;
            exclude.forEach((pattern) => {
                const basePathPattern = '(' + basePath.replace(/\\/g, '/')
                    .replace(/[\-\[\]\/{}()+?.\\^$|*]/g, '\\$&') + ')?';
                pattern = pattern
                    .replace(/\\/g, '/')
                    .replace(/[\-\[\]{}()+?.\\^$|]/g, '\\$&')
                    .replace(/\*\*/g, '(?:.*)')
                    .replace(/\*/g, '(?:[^/]*)')
                    .replace(/^/, basePathPattern);
                const re = new RegExp('^' + pattern + '$');
                fileNames = fileNames.filter(x => !x.replace(/\\/g, '/').match(re));
            });
        }
        else {
            fileNames = fileNames.filter(fileName => !/\.spec\.ts$/.test(fileName));
        }
        this._rootFilePath = fileNames;
        // By default messages will be generated in basePath
        let genDir = basePath;
        if (options.genDir) {
            genDir = path.resolve(process.cwd(), options.genDir);
        }
        this._compilerOptions = tsConfig.options;
        this._angularCompilerOptions = Object.assign(
        // kept for compatibility with Angular <v5.0.0-beta.7+
        { genDir }, this._compilerOptions, tsConfig.raw['angularCompilerOptions'], { basePath, outDir: genDir });
        this._basePath = basePath;
        // this._compilerHost = new WebpackCompilerHost(this._compilerOptions, this._basePath);
        this._compilerHost = ts.createCompilerHost(this._compilerOptions, true);
        this._program = ts.createProgram(this._rootFilePath, this._compilerOptions, this._compilerHost);
        if (options.hasOwnProperty('i18nFormat')) {
            this._i18nFormat = options.i18nFormat;
        }
        if (options.hasOwnProperty('locale')) {
            if (ngtools_api_1.VERSION.major === '2') {
                console.warn("The option '--locale' is only available on the xi18n command"
                    + ' starting from Angular v4, please update to a newer version.', '\n\n');
            }
            this._locale = options.locale;
        }
        if (options.hasOwnProperty('outFile')) {
            if (ngtools_api_1.VERSION.major === '2') {
                console.warn("The option '--out-file' is only available on the xi18n command"
                    + ' starting from Angular v4, please update to a newer version.', '\n\n');
            }
            this._outFile = options.outFile;
        }
        this._resourceLoader = new resource_loader_1.WebpackResourceLoader();
    }
    apply(compiler) {
        compiler.hooks.make.tapAsync('extract-i8n', (compilation, cb) => this._make(compilation, cb));
        compiler.hooks.afterEmit.tapAsync('extract-i8n', (compilation, cb) => {
            compilation._ngToolsWebpackXi18nPluginInstance = null;
            cb();
        });
    }
    _make(compilation, cb) {
        if (compilation._ngToolsWebpackXi18nPluginInstance) {
            return cb(new Error('An @ngtools/webpack xi18n plugin already exist for ' +
                'this compilation.'));
        }
        if (!compilation._ngToolsWebpackPluginInstance) {
            return cb(new Error('An @ngtools/webpack aot plugin does not exists ' +
                'for this compilation'));
        }
        compilation._ngToolsWebpackXi18nPluginInstance = this;
        this._resourceLoader.update(compilation);
        Promise.resolve()
            .then(() => {
            return ngtools_api_1.__NGTOOLS_PRIVATE_API_2.extractI18n({
                basePath: this._basePath,
                compilerOptions: this._compilerOptions,
                program: this._program,
                host: this._compilerHost,
                angularCompilerOptions: this._angularCompilerOptions,
                i18nFormat: this._i18nFormat || '',
                locale: this._locale,
                outFile: this._outFile,
                readResource: (path) => this._resourceLoader.get(path),
            });
        })
            .then(() => cb(), (err) => {
            compilation.errors.push(err);
            cb(err);
        });
    }
}
exports.ExtractI18nPlugin = ExtractI18nPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdF9pMThuX3BsdWdpbi5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvbmd0b29scy93ZWJwYWNrL3NyYy9leHRyYWN0X2kxOG5fcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gscUJBQXFCO0FBQ3JCLG9EQUFvRDtBQUNwRCx3QkFBd0I7QUFDeEIseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QixpQ0FBaUM7QUFDakMsK0NBQWlFO0FBQ2pFLHVEQUEwRDtBQWExRDtJQWdCRSxZQUFZLE9BQWlDO1FBVnJDLHFCQUFnQixHQUFRLElBQUksQ0FBQztRQUM3Qiw0QkFBdUIsR0FBUSxJQUFJLENBQUM7UUFVMUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRU8sYUFBYSxDQUFDLE9BQWlDO1FBQ3JELEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1RUFBdUUsQ0FBQyxDQUFDO1FBQzNGLENBQUM7UUFDRCw2RkFBNkY7UUFDN0YsSUFBSSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFOUQsdUJBQXVCO1FBQ3ZCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0RSxJQUFJLFFBQVEsR0FBRyxhQUFhLENBQUM7UUFDN0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDeEMsUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxD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QUMsaURBQWlEO2dCQUNuRSxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7UUFDN0IsQ0FBQztRQUVELFdBQVcsQ0FBQyxrQ0FBa0MsR0FBRyxJQUFJLENBQUM7UUFFdEQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFekMsT0FBTyxDQUFDLE9BQU8sRUFBRTthQUNkLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVCxNQUFNLENBQUMscUNBQXVCLENBQUMsV0FBVyxDQUFDO2dCQUN6QyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3hCLGVBQWUsRUFBRSxJQUFJLENBQUMsZ0JBQWdCO2dCQUN0QyxPQUFPLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ3RCLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYTtnQkFDeEIsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLHVCQUF1QjtnQkFDcEQsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLElBQUksRUFBRTtnQkFDbEMsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNwQixPQUFPLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBRXRCLFlBQVksRUFBRSxDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2FBQy9ELENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQVEsRUFBRSxFQUFFO1lBQzdCLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNWLENBQUMsQ0FBQyxDQUFDO0lBRVAsQ0FBQztDQUNGO0FBcktELDhDQXFLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbi8vIFRPRE86IGZpeCB0eXBpbmdzLlxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWdsb2JhbC10c2xpbnQtZGlzYWJsZVxuLy8gdHNsaW50OmRpc2FibGU6bm8tYW55XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQgeyBWRVJTSU9OLCBfX05HVE9PTFNfUFJJVkFURV9BUElfMiB9IGZyb20gJy4vbmd0b29sc19hcGknO1xuaW1wb3J0IHsgV2VicGFja1Jlc291cmNlTG9hZGVyIH0gZnJvbSAnLi9yZXNvdXJjZV9sb2FkZXInO1xuaW1wb3J0IHsgVGFwYWJsZSB9IGZyb20gJy4vd2VicGFjayc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0cmFjdEkxOG5QbHVnaW5PcHRpb25zIHtcbiAgdHNDb25maWdQYXRoOiBzdHJpbmc7XG4gIGJhc2VQYXRoPzogc3RyaW5nO1xuICBnZW5EaXI/OiBzdHJpbmc7XG4gIGkxOG5Gb3JtYXQ/OiBzdHJpbmc7XG4gIGxvY2FsZT86IHN0cmluZztcbiAgb3V0RmlsZT86IHN0cmluZztcbiAgZXhjbHVkZT86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgY2xhc3MgRXh0cmFjdEkxOG5QbHVnaW4gaW1wbGVtZW50cyBUYXBhYmxlIHtcbiAgcHJpdmF0ZSBfcmVzb3VyY2VMb2FkZXI6IFdlYnBhY2tSZXNvdXJjZUxvYWRlcjtcblxuICBwcml2YXRlIF90c0NvbmZpZ1BhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSBfYmFzZVBhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSBfcm9vdEZpbGVQYXRoOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSBfY29tcGlsZXJPcHRpb25zOiBhbnkgPSBudWxsO1xuICBwcml2YXRlIF9hbmd1bGFyQ29tcGlsZXJPcHRpb25zOiBhbnkgPSBudWxsO1xuICAvLyBwcml2YXRlIF9jb21waWxlckhvc3Q6IFdlYnBhY2tDb21waWxlckhvc3Q7XG4gIHByaXZhdGUgX2NvbXBpbGVySG9zdDogdHMuQ29tcGlsZXJIb3N0O1xuICBwcml2YXRlIF9wcm9ncmFtOiB0cy5Qcm9ncmFtO1xuXG4gIHByaXZhdGUgX2kxOG5Gb3JtYXQ/OiBzdHJpbmc7XG4gIHByaXZhdGUgX2xvY2FsZT86IHN0cmluZztcbiAgcHJpdmF0ZSBfb3V0RmlsZT86IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBFeHRyYWN0STE4blBsdWdpbk9wdGlvbnMpIHtcbiAgICB0aGlzLl9zZXR1cE9wdGlvbnMob3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIF9zZXR1cE9wdGlvbnMob3B0aW9uczogRXh0cmFjdEkxOG5QbHVnaW5PcHRpb25zKSB7XG4gICAgaWYgKCFvcHRpb25zLmhhc093blByb3BlcnR5KCd0c0NvbmZpZ1BhdGgnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXN0IHNwZWNpZnkgXCJ0c0NvbmZpZ1BhdGhcIiBpbiB0aGUgY29uZmlndXJhdGlvbiBvZiBAbmd0b29scy93ZWJwYWNrLicpO1xuICAgIH1cbiAgICAvLyBUUyByZXByZXNlbnRzIHBhdGhzIGludGVybmFsbHkgd2l0aCAnLycgYW5kIGV4cGVjdHMgdGhlIHRzY29uZmlnIHBhdGggdG8gYmUgaW4gdGhpcyBmb3JtYXRcbiAgICB0aGlzLl90c0NvbmZpZ1BhdGggPSBvcHRpb25zLnRzQ29uZmlnUGF0aC5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cbiAgICAvLyBDaGVjayB0aGUgYmFzZSBwYXRoLlxuICAgIGNvbnN0IG1heWJlQmFzZVBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgdGhpcy5fdHNDb25maWdQYXRoKTtcbiAgICBsZXQgYmFzZVBhdGggPSBtYXliZUJhc2VQYXRoO1xuICAgIGlmIChmcy5zdGF0U3luYyhtYXliZUJhc2VQYXRoKS5pc0ZpbGUoKSkge1xuICAgICAgYmFzZVBhdGggPSBwYXRoLmRpcm5hbWUoYmFzZVBhdGgpO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnYmFzZVBhdGgnKSkge1xuICAgICAgYmFzZVBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgb3B0aW9ucy5iYXNlUGF0aCB8fCAnJyk7XG4gICAgfVxuXG4gICAgbGV0IHRzQ29uZmlnSnNvbjogYW55ID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgdHNDb25maWdKc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmModGhpcy5fdHNDb25maWdQYXRoLCAndXRmOCcpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQW4gZXJyb3IgaGFwcGVuZWQgd2hpbGUgcGFyc2luZyAke3RoaXMuX3RzQ29uZmlnUGF0aH0gSlNPTjogJHtlcnJ9LmApO1xuICAgIH1cbiAgICBjb25zdCB0c0NvbmZpZyA9IHRzLnBhcnNlSnNvbkNvbmZpZ0ZpbGVDb250ZW50KFxuICAgICAgdHNDb25maWdKc29uLCB0cy5zeXMsIGJhc2VQYXRoLCB1bmRlZmluZWQsIHRoaXMuX3RzQ29uZmlnUGF0aCk7XG5cbiAgICBsZXQgZmlsZU5hbWVzID0gdHNDb25maWcuZmlsZU5hbWVzO1xuICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCdleGNsdWRlJykpIHtcbiAgICAgIGNvbnN0IGV4Y2x1ZGU6IHN0cmluZ1tdID0gdHlwZW9mIG9wdGlvbnMuZXhjbHVkZSA9PSAnc3RyaW5nJ1xuICAgICAgICA/IFtvcHRpb25zLmV4Y2x1ZGUgYXMgc3RyaW5nXSA6IChvcHRpb25zLmV4Y2x1ZGUgYXMgc3RyaW5nW10pO1xuXG4gICAgICBleGNsdWRlLmZvckVhY2goKHBhdHRlcm46IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBiYXNlUGF0aFBhdHRlcm4gPSAnKCcgKyBiYXNlUGF0aC5yZXBsYWNlKC9cXFxcL2csICcvJylcbiAgICAgICAgICAgIC5yZXBsYWNlKC9bXFwtXFxbXFxdXFwve30oKSs/LlxcXFxeJHwqXS9nLCAnXFxcXCQmJykgKyAnKT8nO1xuICAgICAgICBwYXR0ZXJuID0gcGF0dGVyblxuICAgICAgICAvLyBSZXBsYWNlIHdpbmRvd3MgcGF0aCBzZXBhcmF0b3JzIHdpdGggZm9yd2FyZCBzbGFzaGVzLlxuICAgICAgICAgIC5yZXBsYWNlKC9cXFxcL2csICcvJylcbiAgICAgICAgICAvLyBFc2NhcGUgY2hhcmFjdGVycyB0aGF0IGFyZSB1c2VkIG5vcm1hbGx5IGluIHJlZ2V4ZXMsIGV4Y2VwdCBzdGFycy5cbiAgICAgICAgICAucmVwbGFjZSgvW1xcLVxcW1xcXXt9KCkrPy5cXFxcXiR8XS9nLCAnXFxcXCQmJylcbiAgICAgICAgICAvLyBUd28gc3RhcnMgcmVwbGFjZW1lbnQuXG4gICAgICAgICAgLnJlcGxhY2UoL1xcKlxcKi9nLCAnKD86LiopJylcbiAgICAgICAgICAvLyBPbmUgc3RhciByZXBsYWNlbWVudC5cbiAgICAgICAgICAucmVwbGFjZSgvXFwqL2csICcoPzpbXi9dKiknKVxuICAgICAgICAgIC8vIEVzY2FwZSBjaGFyYWN0ZXJzIGZyb20gdGhlIGJhc2VQYXRoIGFuZCBtYWtlIHN1cmUgaXQncyBmb3J3YXJkIHNsYXNoZXMuXG4gICAgICAgICAgLnJlcGxhY2UoL14vLCBiYXNlUGF0aFBhdHRlcm4pO1xuXG4gICAgICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cCgnXicgKyBwYXR0ZXJuICsgJyQnKTtcbiAgICAgICAgZmlsZU5hbWVzID0gZmlsZU5hbWVzLmZpbHRlcih4ID0+ICF4LnJlcGxhY2UoL1xcXFwvZywgJy8nKS5tYXRjaChyZSkpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbGVOYW1lcyA9IGZpbGVOYW1lcy5maWx0ZXIoZmlsZU5hbWUgPT4gIS9cXC5zcGVjXFwudHMkLy50ZXN0KGZpbGVOYW1lKSk7XG4gICAgfVxuICAgIHRoaXMuX3Jvb3RGaWxlUGF0aCA9IGZpbGVOYW1lcztcblxuICAgIC8vIEJ5IGRlZmF1bHQgbWVzc2FnZXMgd2lsbCBiZSBnZW5lcmF0ZWQgaW4gYmFzZVBhdGhcbiAgICBsZXQgZ2VuRGlyID0gYmFzZVBhdGg7XG5cbiAgICBpZiAob3B0aW9ucy5nZW5EaXIpIHtcbiAgICAgIGdlbkRpciA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBvcHRpb25zLmdlbkRpcik7XG4gICAgfVxuXG4gICAgdGhpcy5fY29tcGlsZXJPcHRpb25zID0gdHNDb25maWcub3B0aW9ucztcbiAgICB0aGlzLl9hbmd1bGFyQ29tcGlsZXJPcHRpb25zID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIC8vIGtlcHQgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBBbmd1bGFyIDx2NS4wLjAtYmV0YS43K1xuICAgICAgeyBnZW5EaXIgfSxcbiAgICAgIHRoaXMuX2NvbXBpbGVyT3B0aW9ucyxcbiAgICAgIHRzQ29uZmlnLnJhd1snYW5ndWxhckNvbXBpbGVyT3B0aW9ucyddLFxuICAgICAgeyBiYXNlUGF0aCwgb3V0RGlyOiBnZW5EaXIgfSxcbiAgICApO1xuXG4gICAgdGhpcy5fYmFzZVBhdGggPSBiYXNlUGF0aDtcblxuICAgIC8vIHRoaXMuX2NvbXBpbGVySG9zdCA9IG5ldyBXZWJwYWNrQ29tcGlsZXJIb3N0KHRoaXMuX2NvbXBpbGVyT3B0aW9ucywgdGhpcy5fYmFzZVBhdGgpO1xuICAgIHRoaXMuX2NvbXBpbGVySG9zdCA9IHRzLmNyZWF0ZUNvbXBpbGVySG9zdCh0aGlzLl9jb21waWxlck9wdGlvbnMsIHRydWUpO1xuICAgIHRoaXMuX3Byb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKFxuICAgICAgdGhpcy5fcm9vdEZpbGVQYXRoLCB0aGlzLl9jb21waWxlck9wdGlvbnMsIHRoaXMuX2NvbXBpbGVySG9zdCk7XG5cbiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnaTE4bkZvcm1hdCcpKSB7XG4gICAgICB0aGlzLl9pMThuRm9ybWF0ID0gb3B0aW9ucy5pMThuRm9ybWF0O1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbG9jYWxlJykpIHtcbiAgICAgIGlmIChWRVJTSU9OLm1ham9yID09PSAnMicpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiVGhlIG9wdGlvbiAnLS1sb2NhbGUnIGlzIG9ubHkgYXZhaWxhYmxlIG9uIHRoZSB4aTE4biBjb21tYW5kXCJcbiAgICAgICAgICArICcgc3RhcnRpbmcgZnJvbSBBbmd1bGFyIHY0LCBwbGVhc2UgdXBkYXRlIHRvIGEgbmV3ZXIgdmVyc2lvbi4nLCAnXFxuXFxuJyk7XG4gICAgICB9XG4gICAgICB0aGlzLl9sb2NhbGUgPSBvcHRpb25zLmxvY2FsZTtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ291dEZpbGUnKSkge1xuICAgICAgaWYgKFZFUlNJT04ubWFqb3IgPT09ICcyJykge1xuICAgICAgICBjb25zb2xlLndhcm4oXCJUaGUgb3B0aW9uICctLW91dC1maWxlJyBpcyBvbmx5IGF2YWlsYWJsZSBvbiB0aGUgeGkxOG4gY29tbWFuZFwiXG4gICAgICAgICAgKyAnIHN0YXJ0aW5nIGZyb20gQW5ndWxhciB2NCwgcGxlYXNlIHVwZGF0ZSB0byBhIG5ld2VyIHZlcnNpb24uJywgJ1xcblxcbicpO1xuICAgICAgfVxuICAgICAgdGhpcy5fb3V0RmlsZSA9IG9wdGlvbnMub3V0RmlsZTtcbiAgICB9XG5cbiAgICB0aGlzLl9yZXNvdXJjZUxvYWRlciA9IG5ldyBXZWJwYWNrUmVzb3VyY2VMb2FkZXIoKTtcbiAgfVxuXG4gIGFwcGx5KGNvbXBpbGVyOiBhbnkpIHtcbiAgICBjb21waWxlci5ob29rcy5tYWtlLnRhcEFzeW5jKFxuICAgICAgJ2V4dHJhY3QtaThuJyxcbiAgICAgIChjb21waWxhdGlvbjogYW55LCBjYjogYW55KSA9PiB0aGlzLl9tYWtlKGNvbXBpbGF0aW9uLCBjYiksXG4gICAgKTtcblxuICAgIGNvbXBpbGVyLmhvb2tzLmFmdGVyRW1pdC50YXBBc3luYygnZXh0cmFjdC1pOG4nLCAoY29tcGlsYXRpb246IGFueSwgY2I6IGFueSkgPT4ge1xuICAgICAgY29tcGlsYXRpb24uX25nVG9vbHNXZWJwYWNrWGkxOG5QbHVnaW5JbnN0YW5jZSA9IG51bGw7XG4gICAgICBjYigpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfbWFrZShjb21waWxhdGlvbjogYW55LCBjYjogKGVycj86IGFueSwgcmVxdWVzdD86IGFueSkgPT4gdm9pZCkge1xuICAgIGlmIChjb21waWxhdGlvbi5fbmdUb29sc1dlYnBhY2tYaTE4blBsdWdpbkluc3RhbmNlKSB7XG4gICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdBbiBAbmd0b29scy93ZWJwYWNrIHhpMThuIHBsdWdpbiBhbHJlYWR5IGV4aXN0IGZvciAnICtcbiAgICAgICAgJ3RoaXMgY29tcGlsYXRpb24uJykpO1xuICAgIH1cbiAgICBpZiAoIWNvbXBpbGF0aW9uLl9uZ1Rvb2xzV2VicGFja1BsdWdpbkluc3RhbmNlKSB7XG4gICAgICByZXR1cm4gY2IobmV3IEVycm9yKCdBbiBAbmd0b29scy93ZWJwYWNrIGFvdCBwbHVnaW4gZG9lcyBub3QgZXhpc3RzICcgK1xuICAgICAgICAnZm9yIHRoaXMgY29tcGlsYXRpb24nKSk7XG4gICAgfVxuXG4gICAgY29tcGlsYXRpb24uX25nVG9vbHNXZWJwYWNrWGkxOG5QbHVnaW5JbnN0YW5jZSA9IHRoaXM7XG5cbiAgICB0aGlzLl9yZXNvdXJjZUxvYWRlci51cGRhdGUoY29tcGlsYXRpb24pO1xuXG4gICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIF9fTkdUT09MU19QUklWQVRFX0FQSV8yLmV4dHJhY3RJMThuKHtcbiAgICAgICAgICBiYXNlUGF0aDogdGhpcy5fYmFzZVBhdGgsXG4gICAgICAgICAgY29tcGlsZXJPcHRpb25zOiB0aGlzLl9jb21waWxlck9wdGlvbnMsXG4gICAgICAgICAgcHJvZ3JhbTogdGhpcy5fcHJvZ3JhbSxcbiAgICAgICAgICBob3N0OiB0aGlzLl9jb21waWxlckhvc3QsXG4gICAgICAgICAgYW5ndWxhckNvbXBpbGVyT3B0aW9uczogdGhpcy5fYW5ndWxhckNvbXBpbGVyT3B0aW9ucyxcbiAgICAgICAgICBpMThuRm9ybWF0OiB0aGlzLl9pMThuRm9ybWF0IHx8ICcnLFxuICAgICAgICAgIGxvY2FsZTogdGhpcy5fbG9jYWxlLFxuICAgICAgICAgIG91dEZpbGU6IHRoaXMuX291dEZpbGUsXG5cbiAgICAgICAgICByZWFkUmVzb3VyY2U6IChwYXRoOiBzdHJpbmcpID0+IHRoaXMuX3Jlc291cmNlTG9hZGVyLmdldChwYXRoKSxcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4gY2IoKSwgKGVycjogYW55KSA9PiB7XG4gICAgICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKGVycik7XG4gICAgICAgIGNiKGVycik7XG4gICAgICB9KTtcblxuICB9XG59XG4iXX0=